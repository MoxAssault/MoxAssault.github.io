window.addEventListener("DOMContentLoaded",(()=>{const btn=document.getElementById("searchBtn");const input=document.getElementById("idInput");const suggestions=document.getElementById("suggestions");const gameCardContainer=document.getElementById("gameCardContainer");const categoryGrid=document.getElementById("categoryGrid");window.romUpdate=setSectionFieldsWithBundle("romVPSId","romBundled","romGrid");window.b2sUpdate=setSectionFieldsWithBundle("backglassVPSId","backglassBundled","b2sGrid");window.colorRomUpdate=setSectionFieldsWithBundle("coloredROMVPSId","coloredROMBundled","cRomGrid");window.pupUpdate=setSectionFieldsWithBundle("pupVPSId","pupBundled","pupGrid");document.querySelectorAll('.modalContainer input[type="checkbox"][name$="Override_check"]').forEach((cb=>{const baseName=cb.name.replace(/_check$/,"");const input=cb.closest(".lowerOverrideRow, .tableNameOverride").querySelector(`input[name="${baseName}"]`);if(!input)return;function update(){input.disabled=!cb.checked||cb.disabled}cb.addEventListener("change",update);update()}));["tableVPSId","vpxVPSId","romVPSId","backglassVPSId","coloredROMVPSId","pupVPSId"].forEach((name=>{const el=document.querySelector(`.modalContainer input[name="${name}"]`);if(el)el.addEventListener("focus",(function(e){this.blur()}))}));btn.addEventListener("click",(()=>searchById(input,gameCardContainer,categoryGrid)));input.addEventListener("keydown",(e=>{if(e.key==="Enter"){if(window.searchState.activeSuggestionIndex>=0&&window.searchState.lastSuggestions.length){input.value=window.searchState.lastSuggestions[window.searchState.activeSuggestionIndex].id;suggestions.classList.remove("active");searchById(input,gameCardContainer,categoryGrid);e.preventDefault()}else{searchById(input,gameCardContainer,categoryGrid)}}if(["ArrowDown","ArrowUp"].includes(e.key)&&window.searchState.lastSuggestions.length){e.preventDefault();if(e.key==="ArrowDown"){window.searchState.activeSuggestionIndex=Math.min(window.searchState.activeSuggestionIndex+1,window.searchState.lastSuggestions.length-1)}else{window.searchState.activeSuggestionIndex=Math.max(window.searchState.activeSuggestionIndex-1,0)}window.updateSuggestionsUI(suggestions,input,(()=>searchById(input,gameCardContainer,categoryGrid)))}if(e.key==="Escape"){suggestions.classList.remove("active")}}));input.addEventListener("input",(async()=>{const val=input.value.trim().toLowerCase();window.resetSuggestions();if(!val){suggestions.classList.remove("active");return}const data=await window.fetchVPSDB();window.searchState.lastSuggestions=window.filterSuggestions(data,val);if(window.searchState.lastSuggestions.length){suggestions.classList.add("active");window.updateSuggestionsUI(suggestions,input,(()=>searchById(input,gameCardContainer,categoryGrid)))}else{suggestions.classList.remove("active")}}));document.addEventListener("click",(e=>{if(!suggestions.contains(e.target)&&e.target!==input){suggestions.classList.remove("active")}}));document.querySelectorAll(".modalContainer input, .modalContainer textarea").forEach((el=>{if(el.type==="checkbox"){el.checked=false}else{el.value=""}}))}));async function searchById(input,gameCardContainer,categoryGrid){clearAllFields();const rawID=input.value.trim();gameCardContainer.innerHTML="";categoryGrid.innerHTML="";categoryGrid.className="two-per-row";if(!rawID){input.placeholder="!! Please enter a VPS Table ID !!";return}gameCardContainer.innerHTML=`<p>Searching for “${rawID}”…</p>`;let record;try{const data=await window.fetchVPSDB();record=Array.isArray(data)?data.find((r=>r.id?.toLowerCase()===rawID.toLowerCase())):null}catch(err){gameCardContainer.innerHTML=`<p class="error">Error: ${err.message}</p>`;return}if(!record){gameCardContainer.innerHTML=`<p class="error">No entries found for “${rawID}”.</p>`;return}const card=window.renderGameCard(record,rawID);gameCardContainer.innerHTML="";gameCardContainer.appendChild(card);const groupKeys=["tableFiles","b2sFiles","romFiles","altColorFiles","pupPackFiles"];const present=groupKeys.filter((g=>Array.isArray(record[g])&&record[g].length));present.forEach((group=>{const items=record[group];const container=document.createElement("div");container.className="category-container";const lbl=document.createElement("label");lbl.className="category-label";lbl.textContent=window.humanize(group);container.appendChild(lbl);container.dataset.group=group;const select=document.createElement("select");const placeholder=document.createElement("option");placeholder.textContent=`Select a ${window.humanize(group).slice(0,-1)}`;placeholder.disabled=true;placeholder.selected=true;select.appendChild(placeholder);if(group!=="tableFiles"&&group!=="b2sFiles"){select.classList.add("fullwidth-select")}items.forEach((item=>{const opt=document.createElement("option");opt.value=item.id;opt.textContent=item.id;let isBroken=false;if(item.broken===true||item.broken==="true")isBroken=true;if(!isBroken&&item.urls){if(Array.isArray(item.urls)){isBroken=item.urls.some((u=>u&&(u.broken===true||u.broken==="true")))}else if(typeof item.urls==="object"){isBroken=Object.values(item.urls).some((u=>u&&(u.broken===true||u.broken==="true")))}}if(isBroken){opt.disabled=true;opt.textContent+=" (❌Broken)";opt.className="broken-option"}select.appendChild(opt)}));container.appendChild(select);if(group!=="tableFiles"){const clearBtn=document.createElement("button");clearBtn.type="button";clearBtn.className="clear-select-btn";clearBtn.innerHTML="✖";clearBtn.addEventListener("click",(()=>{container.querySelector(".thumb-small").src="";container.querySelector(".thumb-preview").src="";select.selectedIndex=0;select.dispatchEvent(new Event("change"))}));container.appendChild(clearBtn)}let thumb,preview;if(group==="tableFiles"||group==="b2sFiles"){const thumbWrap=document.createElement("span");thumbWrap.className="thumbnail-wrapper";thumb=document.createElement("img");thumb.className="thumb-small";thumb.alt="";thumbWrap.appendChild(thumb);preview=document.createElement("img");preview.className="thumb-preview";preview.alt="";thumbWrap.appendChild(preview);container.appendChild(thumbWrap)}const display=document.createElement("div");display.className="item-display";container.appendChild(display);select.addEventListener("change",(()=>{if(group==="tableFiles"){compileBtn.disabled=false}display.innerHTML="";const item=items.find((i=>i.id===select.value));if(!item)return;if(thumb)thumb.src=item.imgUrl||"";if(preview)preview.src=item.imgUrl||"";const dl=document.createElement("dl");const dateRow=document.createElement("div");dateRow.className="date";["createdAt","updatedAt"].forEach((key=>{if(item[key]){const w=document.createElement("div");const dt=document.createElement("dt");dt.textContent=`${window.humanize(key.replace(/At$/,""))}:  ${formatDate(item[key])}`;w.appendChild(dt);dateRow.appendChild(w)}}));display.appendChild(dateRow);const appendField=(k,v)=>{if(["authors","features","tableFormat","version","fileName"].includes(k)&&v.length>0){const dt=document.createElement("dt");dt.textContent=window.humanize(k);dl.appendChild(dt);const wrap=document.createElement("div");wrap.className="bubble-group";const arr=Array.isArray(v)?v:[v];if(arr.length<=4){arr.forEach((val=>{const b=document.createElement("span");b.className="bubble";b.textContent=val;wrap.appendChild(b)}))}else{arr.slice(0,3).forEach((val=>{const b=document.createElement("span");b.className="bubble";b.textContent=val;wrap.appendChild(b)}));const moreBubble=document.createElement("span");moreBubble.className="bubble bubble-more";moreBubble.textContent=`+${arr.length-3} More`;moreBubble.tabIndex=0;const popout=document.createElement("div");popout.className="bubble-popout";arr.slice(3).forEach((val=>{const li=document.createElement("div");li.className="bubble";li.textContent=val;popout.appendChild(li)}));moreBubble.appendChild(popout);moreBubble.addEventListener("click",(e=>{e.stopPropagation();const isVisible=popout.style.display==="block";document.querySelectorAll(".bubble-popout").forEach((p=>p.style.display="none"));popout.style.display=isVisible?"none":"block"}));moreBubble.addEventListener("mouseleave",(()=>{popout.style.display="none"}));moreBubble.addEventListener("blur",(()=>{popout.style.display="none"}));document.body.addEventListener("click",(()=>{popout.style.display="none"}));wrap.appendChild(moreBubble)}const dd=document.createElement("dd");dd.appendChild(wrap);dl.appendChild(dd);return}if(["game","urls","imgUrl","createdAt","updatedAt"].includes(k))return;const dt=document.createElement("dt");dt.textContent=window.humanize(k);const dd=document.createElement("dd");dd.textContent=Array.isArray(v)?v.join(", "):v;dl.appendChild(dt);dl.appendChild(dd)};["authors","features","tableFormat","version"].forEach((k=>{if(item[k]&&item[k].length>0)appendField(k,item[k])}));Object.keys(item).filter((k=>!["id","_group","game","urls","imgUrl","createdAt","updatedAt","authors","features","tableFormat","version","comment","folder","type","theme"].includes(k))).sort().forEach((k=>appendField(k,item[k])));display.appendChild(dl);if(item.comment){const commentLabel=document.createElement("div");commentLabel.className="comment-label";commentLabel.textContent="Comments";display.appendChild(commentLabel);const commentDiv=document.createElement("div");commentDiv.className="comment-box";commentDiv.textContent=item.comment;display.appendChild(commentDiv)}}));categoryGrid.appendChild(container)}));function formatDate(ts){try{return new Date(ts).toLocaleDateString(undefined,{year:"numeric",month:"short",day:"numeric"})}catch{return ts}}const compileBtn=document.getElementById("compileBtn");if(compileBtn){compileBtn.disabled=true;compileBtn.onclick=e=>{e.preventDefault();const sections=[{title:"Main Fields",fields:window.YML_MAIN_FIELDS},{title:"VPX Files",fields:window.VPX_FIELDS},{title:"Backglass (B2S)",fields:window.B2S_FIELDS},{title:"ROM Files",fields:window.ROM_FIELDS},{title:"Color ROM Files",fields:window.COLOR_ROM_FIELDS},{title:"PUP Pack",fields:window.PUP_FIELDS}];const wrapText=(text,maxLen=120)=>{const words=text.split(" ");const lines=[];let line="";for(const w of words){const candidate=line?line+" "+w:w;if(candidate.length>maxLen){lines.push(line);line=w}else{line=candidate}}if(line)lines.push(line);return lines};document.getElementById("submitYmlBtn").addEventListener("click",(function(){const formData={};document.querySelectorAll(".modalContainer input, .modalContainer textarea").forEach((el=>{if(!el.name)return;if(el.type==="checkbox"){formData[el.name]=el.checked}else{formData[el.name]=el.value}}));sections.forEach((section=>section.fields.forEach((field=>{if(field.type==="array"&&Array.isArray(field.items)){const arr=[];field.items.forEach((item=>{if(formData[item.yml_field]){arr.push(item.yml_field)}delete formData[item.yml_field]}));formData[field.yml_field]=arr}}))));if(formData.fps){formData.fps=parseInt(formData.fps,10)}if(formData.testers){formData.testers=formData.testers.split(",").map((s=>s.trim())).filter(Boolean)}if(formData.backglassAuthorsOverride){formData.backglassAuthorsOverride=formData.backglassAuthorsOverride.split(",").map((s=>s.trim())).filter(Boolean)}const sorted=Object.entries(formData).filter((([_,val])=>{if(_.endsWith("Override_check"))return;if(Array.isArray(val))return val.length>0;if(typeof val==="string")return val.trim()!=="";if(typeof val==="number")return true;if(typeof val==="boolean")return val===true;return false})).sort((([a],[b])=>a.localeCompare(b)));let yml="---\n";for(const[name,val]of sorted){if(name==="pupVPSId"||name==="pupBundled")return;if(Array.isArray(val)){yml+=`${name}:\n`;val.forEach((item=>{const safeItem=item.replace(/"/g,"'");yml+=`  - "${safeItem}"\n`}))}else if(typeof val==="number"){yml+=`${name}: ${val}\n`}else if(typeof val==="boolean"){yml+=`${name}: ${val}\n`}else{const cleanVal=val.replace(/"/g,"'");if((name.endsWith("UrlOverride")||name.endsWith("FileUrl"))&&cleanVal.length>120){yml+="# yamllint disable-line rule:line-length\n"}if(name.endsWith("UrlOverride")||name.endsWith("FileUrl")){yml+=`${name}: "${cleanVal}"\n`}else if(cleanVal.length>120){yml+=`${name}: >-\n`;for(const line of wrapText(cleanVal,120)){yml+=`  ${line}\n`}}else{yml+=`${name}: "${cleanVal}"\n`}}}const blob=new Blob([yml],{type:"text/yaml"});const url=URL.createObjectURL(blob);const a=document.createElement("a");a.href=url;a.download=`${rawID||"output"}_table-config.yml`;document.body.appendChild(a);a.click();setTimeout((()=>{document.body.removeChild(a);URL.revokeObjectURL(url)}),100)}))}}}