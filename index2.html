<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>VPS ID Lookup Test</title>
  <style>
    /* === your styles.css === */
    * { box-sizing: border-box; margin:0; padding:0 }
    body { font-family: Arial, sans-serif; background:#f4f4f4; color:#333; padding:20px }
    .container { max-width:800px; margin:0 auto }
    h1 { text-align:center; margin-bottom:1rem }
    .search-box { display:flex; justify-content:center; margin-bottom:1.5rem }
    #idInput { width:250px; padding:.5rem; border:1px solid #ccc; border-radius:4px 0 0 4px }
    #searchBtn { padding:.5rem 1rem; border:none; background:#0077cc; color:#fff; cursor:pointer; border-radius:0 4px 4px 0 }
    #searchBtn:hover { background:#005fa3 }
    #results h2 { margin-top:1rem; color:#0077cc }
    #results ul { list-style:disc inside; margin-bottom:1rem }
    .error { color:#c00; text-align:center }
  </style>
</head>
<body>
  <div class="container">
    <h1>VPS Table ID Search</h1>
    <div class="search-box">
      <input id="idInput" type="text" placeholder="Enter VPS Table ID">
      <button id="searchBtn">Search</button>
    </div>
    <div id="results"></div>
  </div>

  <script>
    console.log('‚è± script.js loaded');

    // ensure DOM is ready
    window.addEventListener('DOMContentLoaded', () => {
      console.log('‚úÖ DOMContentLoaded');

      const btn = document.getElementById('searchBtn');
      console.log('üîò Found button:', btn);
      if (!btn) return console.error('‚ùå searchBtn not found in DOM');

      btn.addEventListener('click', searchById);
      document.getElementById('idInput')
              .addEventListener('keydown', e => { if (e.key==='Enter') searchById(); });
    });

    const API_URLS = [
  'https://cdn.jsdelivr.net/gh/VirtualPinballSpreadsheet/vps-db/db/vpsdb.json',
  'https://raw.githubusercontent.com/VirtualPinballSpreadsheet/vps-db/master/db/vpsdb.json'
];

window.addEventListener('DOMContentLoaded', () => {
  const btn = document.getElementById('searchBtn');
  const input = document.getElementById('idInput');

  btn.addEventListener('click', searchById);
  input.addEventListener('keydown', e => {
    if (e.key === 'Enter') searchById();
  });
});

async function fetchVPSDB() {
  const resp = await fetch(API_URL);
  if (!resp.ok) throw new Error(`Network error: ${resp.status}`);
  return resp.json();
}

async function searchById() {
  const id = document.getElementById('idInput').value.trim();
  const resultsDiv = document.getElementById('results');
  resultsDiv.innerHTML = '';

  if (!id) {
    resultsDiv.innerHTML = `<p class="error">Please enter a VPS Table ID.</p>`;
    return;
  }

  resultsDiv.innerHTML = `<p>Loading results for ‚Äú${id}‚Äù‚Ä¶</p>`;

  try {
    // 1) Fetch and parse
    const raw = await fetchVPSDB();

    // 2) Normalize into [{ id, entry }, ‚Ä¶]
    const list = Array.isArray(raw)
      ? raw.map(entry => ({ id: entry.tableVPSId || null, entry }))
      : Object.entries(raw).map(([key, entry]) => ({ id: key, entry }));

    console.log('üî¢ total items:', list.length);

    // 3) Filter by either the key or internal field
    const matches = list
      .filter(item => item.id === id || item.entry.tableVPSId === id)
      .map(item => {
        item.entry._vpsID = item.id;
        return item.entry;
      });

    console.log('‚úÖ matches found:', matches.length);

    if (matches.length === 0) {
      resultsDiv.innerHTML = `<p>No entries found for ‚Äú${id}‚Äù.</p>`;
      return;
    }

    // 4) Group by `type`
    const grouped = matches.reduce((acc, entry) => {
      const t = entry.type || 'Unknown';
      (acc[t] = acc[t] || []).push(entry);
      return acc;
    }, {});

    // 5) Render each group
    resultsDiv.innerHTML = '';
    for (const [type, items] of Object.entries(grouped)) {
      const heading = document.createElement('h2');
      heading.textContent = type;
      resultsDiv.appendChild(heading);

      const ul = document.createElement('ul');
      items.forEach(item => {
        const li = document.createElement('li');
        // display either tableName, name, or raw JSON
        li.textContent = item.tableName || item.name || JSON.stringify(item);
        // append the resolved VPS ID
        li.textContent += ` (ID: ${item._vpsID})`;

        // optional: attach download link if present
        if (item.mediaUrl) {
          const a = document.createElement('a');
          a.href = item.mediaUrl;
          a.textContent = ' [Download]';
          a.target = '_blank';
          li.appendChild(a);
        }

        ul.appendChild(li);
      });
      resultsDiv.appendChild(ul);
    }

  } catch (err) {
    console.error(err);
    resultsDiv.innerHTML = `<p class="error">Error: ${err.message}</p>`;
  }
}
  </script>
</body>
</html>
