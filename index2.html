<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>VPS ID Lookup Test</title>
  <style>
    /* === your styles.css === */
    * { box-sizing: border-box; margin:0; padding:0 }
    body { font-family: Arial, sans-serif; background:#f4f4f4; color:#333; padding:20px }
    .container { max-width:800px; margin:0 auto }
    h1 { text-align:center; margin-bottom:1rem }
    .search-box { display:flex; justify-content:center; margin-bottom:1.5rem }
    #idInput { width:250px; padding:.5rem; border:1px solid #ccc; border-radius:4px 0 0 4px }
    #searchBtn { padding:.5rem 1rem; border:none; background:#0077cc; color:#fff; cursor:pointer; border-radius:0 4px 4px 0 }
    #searchBtn:hover { background:#005fa3 }
    #results h2 { margin-top:1rem; color:#0077cc }
    #results ul { list-style:disc inside; margin-bottom:1rem }
    .error { color:#c00; text-align:center }
  </style>
</head>
<body>
  <div class="container">
    <h1>VPS Table ID Search</h1>
    <div class="search-box">
      <input id="idInput" type="text" placeholder="Enter VPS Table ID">
      <button id="searchBtn">Search</button>
    </div>
    <div id="results"></div>
  </div>

  <script>
    console.log('‚è± script.js loaded');

    // ensure DOM is ready
    window.addEventListener('DOMContentLoaded', () => {
      console.log('‚úÖ DOMContentLoaded');

      const btn = document.getElementById('searchBtn');
      console.log('üîò Found button:', btn);
      if (!btn) return console.error('‚ùå searchBtn not found in DOM');

      btn.addEventListener('click', searchById);
      document.getElementById('idInput')
              .addEventListener('keydown', e => { if (e.key==='Enter') searchById(); });
    });

    const API_URLS = [
  'https://cdn.jsdelivr.net/gh/VirtualPinballSpreadsheet/vps-db/db/vpsdb.json',
  'https://raw.githubusercontent.com/VirtualPinballSpreadsheet/vps-db/master/db/vpsdb.json'
];

async function fetchVPSDB() {
  for (const url of API_URLS) {
    try {
      const resp = await fetch(url);
      if (!resp.ok) throw new Error(`Status ${resp.status}`);
      return resp.json();
    } catch (e) {
      console.warn(`Failed to fetch from ${url}: ${e.message}`);
    }
  }
  throw new Error('All VPS DB fetch attempts failed');
}

    async function searchById() {
      console.log('‚ñ∂Ô∏è searchById() called');
      const id = document.getElementById('idInput').value.trim();
      const resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML = '';

      if (!id) {
        console.log('‚ö†Ô∏è empty ID');
        return resultsDiv.innerHTML = `<p class="error">Please enter a VPS Table ID.</p>`;
      }

      resultsDiv.innerHTML = `<p>Loading results for ‚Äú${id}‚Äù‚Ä¶</p>`;

      try {
        const resp = await fetch(API_URL);
        console.log('üì∂ fetch status:', resp.status);
        if (!resp.ok) throw new Error(`Network error: ${resp.status}`);

        const data = await fetchVPSDB();
        console.log('üîç raw data type:', typeof data);

        const items = Array.isArray(data) ? data : Object.values(data);
        console.log('üìã total items:', items.length);

        if (items.length === 0) {
          return resultsDiv.innerHTML = `<p class="error">Database is empty!</p>`;
        }

        const sample = items[0];
        const idKey = Object.keys(sample)
                             .find(k => k.toLowerCase().includes('vpsid'));
        console.log('üîë detected ID key:', idKey);

        if (!idKey) {
          return resultsDiv.innerHTML = `<p class="error">No ‚ÄúVPS ID‚Äù field found.</p>`;
        }

        const matches = items.filter(item => item[idKey] === id);
        console.log(`‚úÖ found ${matches.length} matches for ID ‚Äú${id}‚Äù`);

        if (matches.length === 0) {
          return resultsDiv.innerHTML = `<p>No entries found for ‚Äú${id}‚Äù.</p>`;
        }

        // group by type
        const grouped = matches.reduce((acc, item) => {
          const t = item.type || 'Unknown';
          (acc[t] = acc[t]||[]).push(item);
          return acc;
        }, {});

        // render
        resultsDiv.innerHTML = '';
        for (const [type, list] of Object.entries(grouped)) {
          const h2 = document.createElement('h2');
          h2.textContent = type;
          resultsDiv.appendChild(h2);

          const ul = document.createElement('ul');
          list.forEach(item => {
            const li = document.createElement('li');
            li.textContent = item.tableName || item.name || JSON.stringify(item);
            if (item.mediaUrl) {
              const a = document.createElement('a');
              a.href = item.mediaUrl;
              a.textContent = ' [Download]';
              a.target = '_blank';
              li.appendChild(a);
            }
            ul.appendChild(li);
          });
          resultsDiv.appendChild(ul);
        }

      } catch (err) {
        console.error(err);
        resultsDiv.innerHTML = `<p class="error">Error: ${err.message}</p>`;
      }
    }
  </script>
</body>
</html>
